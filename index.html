<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>罗汉洞 · 二零二六元旦</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        :root { --red: #8b0000; --paper: #f4e8d1; --gold: #b8860b; --lotus: #ffb6c1; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--paper); font-family: "Kaiti", "楷体", serif; overflow: hidden; user-select: none; touch-action: none; }
        .global-bg { position: fixed; width: 100%; height: 100%; background: url('bg.jpg') center/cover; opacity: 0.4; z-index: 1; pointer-events: none; }
        #video-container { position: fixed; top: 10px; right: 10px; width: 110px; height: 82px; border: 2px solid var(--gold); border-radius: 6px; overflow: hidden; z-index: 100; opacity: 0.6; transform: scaleX(-1); display: none; }
        #video-element { width: 100%; height: 100%; object-fit: cover; }
        
        /* 仅在 AR 模式激活时隐藏鼠标 */
        .ar-active { cursor: none !important; }

        #lotus-cursor { position: fixed; width: 80px; height: 80px; pointer-events: none; z-index: 1000; display: none; filter: drop-shadow(0 0 10px var(--lotus)); }
        .lotus-svg { width: 100%; height: 100%; fill: var(--lotus); }
        .stage-3d { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; perspective: 1500px; z-index: 10; }
        .carousel { width: 160px; height: 240px; position: relative; transform-style: preserve-3d; }
        .card { position: absolute; width: 160px; height: 240px; left: 0; top: 0; border: 2px solid var(--gold); border-radius: 10px; background: url('牌背.jpg') center/cover; backface-visibility: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: border-color 0.4s, box-shadow 0.4s, transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .card.target-aim { border-color: var(--lotus); box-shadow: 0 0 30px var(--lotus); transform: translate3d(var(--tx), -25px, 60px) !important; }
        .card-picked { animation: pickUp 1.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; z-index: 2000; }
        @keyframes pickUp { 0% { transform: translate3d(var(--tx), -25px, 60px) scale(1.1); } 100% { transform: translate3d(var(--tx), -300px, 1500px) rotateY(1080deg); opacity: 0; } }
        
        .page-home { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
        .mode-btn { margin: 12px; padding: 18px 50px; background: var(--red); color: white; border-radius: 50px; cursor: pointer; border: 2px solid var(--gold); font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; pointer-events: auto !important; }
        .mode-btn:hover { transform: scale(1.05); }
        .mode-btn:disabled { opacity: 0.5; cursor: wait; }
        
        .result-page { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; z-index: 300; background: var(--paper); cursor: default !important; }
        .spirit-zone { width: 100%; height: 45%; display: flex; justify-content: center; align-items: flex-end; opacity: 0; transform: translateY(30px); transition: 2s; z-index: 10; margin-bottom: 10px; }
        .spirit-active { opacity: 0.95; transform: translateY(0); }
        .spirit-img { height: 95%; mix-blend-mode: multiply; }
        .scroll-wrapper { width: 90%; max-width: 380px; transform: scaleY(0); transform-origin: top; transition: 1.5s; z-index: 10; }
        .scroll-active { transform: scaleY(1); }
        .scroll-axle { height: 22px; width: 106%; background: linear-gradient(to right, #4a2d18, #8b4513, #4a2d18); border-radius: 11px; margin-left: -3%; }
        .scroll-content { background: #fffdf7; border-left: 12px solid var(--red); border-right: 12px solid var(--red); padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #status-tip { position: fixed; bottom: 8%; width: 100%; text-align: center; color: var(--red); font-size: 1.2rem; font-weight: bold; z-index: 60; letter-spacing: 3px; pointer-events: none;}
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="global-bg"></div>
<div id="video-container"><video id="video-element" playsinline></video></div>
<audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>

<div id="lotus-cursor">
    <svg class="lotus-svg" viewBox="0 0 100 100">
        <path d="M50 10 C60 30 90 40 90 60 C90 80 70 90 50 90 C30 90 10 80 10 60 C10 40 40 30 50 10 Z" fill-opacity="0.8"/>
        <path d="M50 20 C55 35 75 45 75 60 C75 75 65 80 50 80 C35 80 25 75 25 60 C25 45 45 35 50 20 Z" fill="#fff" fill-opacity="0.5"/>
    </svg>
</div>

<div id="home-page" class="page-home">
    <div style="color: var(--red); font-size: 1.2rem; margin-bottom: 5px; letter-spacing: 5px;">丙午春元 · 二零二六</div>
    <h1 style="color: var(--red); font-size: 3.8rem; letter-spacing: 12px; margin:0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">罗汉洞</h1>
    <div style="margin-top: 40px;">
        <button id="ar-btn" class="mode-btn" onclick="initExperience('AR')" disabled>开启法眼 (手势寻缘)</button>
        <button id="mouse-btn" class="mode-btn" onclick="initExperience('TOUCH')">指尖感应 (极速滑动)</button>
    </div>
    <div id="loading-txt" style="margin-top: 25px; color: var(--gold);">—— 法鼓已备，静候法音 ——</div>
</div>

<div id="draw-page" class="hidden">
    <div class="stage-3d"><div id="carousel" class="carousel"></div></div>
    <div id="status-tip">法轮常转 · 拈花一指</div>
</div>

<div id="result-page" class="result-page hidden">
    <div class="global-bg"></div>
    <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; position:relative; z-index:10;">
        <div id="spirit-box" class="spirit-zone"><img id="res-spirit-img" class="spirit-img" src=""></div>
        <div id="scroll-obj" class="scroll-wrapper">
            <div class="scroll-axle"></div>
            <div class="scroll-content">
                <h2 id="res-name" style="color: var(--red); text-align: center; font-size: 1.8rem; margin:0;"></h2>
                <div id="res-poem" style="font-size: 1.3rem; line-height: 1.6; text-align: center; margin: 15px 0; font-weight: bold; white-space: pre-wrap;"></div>
                <div style="padding: 12px; border-top: 1px dashed var(--gold); background: rgba(139,0,0,0.02);">
                    <strong style="color: var(--red);">【新年启示】</strong>
                    <div id="res-interp" style="margin-top:5px; color: #444; font-size: 0.95rem; line-height:1.4;"></div>
                </div>
                <button onclick="location.reload()" style="width:100%; margin-top:15px; padding:12px; background:var(--red); color:white; border:none; border-radius:4px; cursor:pointer;">合卷谢礼</button>
            </div>
            <div class="scroll-axle"></div>
        </div>
    </div>
</div>

<script>
    const LOHANS = [
        { name: "欢喜地尊者", img: 1 }, { name: "光明幢尊者", img: 2 }, { name: "无畏心尊者", img: 3 }, 
        { name: "布施手尊者", img: 4 }, { name: "禅定藏尊者", img: 5 }, { name: "智慧锋尊者", img: 5 }, 
        { name: "忍辱铠尊者", img: 6 }, { name: "精进峰尊者", img: 6 }, { name: "真实语尊者", img: 7 }, 
        { name: "慈悲眼尊者", img: 8 }, { name: "随缘赴尊者", img: 9 }, { name: "常欢喜尊者", img: 1 }, 
        { name: "金刚根尊者", img: 3 }, { name: "广目天尊者", img: 10 }, { name: "解脱缚尊者", img: 12 }, 
        { name: "妙音声尊者", img: 7 }, { name: "不动地尊者", img: 3 }, { name: "药王树尊者", img: 13 }, 
        { name: "福田耕尊者", img: 4 }, { name: "光明灯尊者", img: 2 }, { name: "平等心尊者", img: 14 }, 
        { name: "降魔杖尊者", img: 18 }, { name: "慈悲藏尊者", img: 8 }, { name: "方便门尊者", img: 9 }, 
        { name: "清净戒尊者", img: 17 }, { name: "精进铠尊者", img: 6 }, { name: "般若光尊者", img: 5 }, 
        { name: "不退轮尊者", img: 16 }, { name: "普观察尊者", img: 10 }, { name: "满愿树尊者", img: 15 }, 
        { name: "无尽意尊者", img: 17 }, { name: "除忧恼尊者", img: 20 }, { name: "寂静空尊者", img: 20 }, 
        { name: "坚固信尊者", img: 16 }, { name: "法雨施尊者", img: 13 }, { name: "常觉悟尊者", img: 19 }, 
        { name: "功德聚尊者", img: 15 }, { name: "智慧剑尊者", img: 5 }, { name: "心月轮尊者", img: 19 }, 
        { name: "解脱道尊者", img: 20 }, { name: "无碍辩尊者", img: 7 }, { name: "精进臂尊者", img: 18 }, 
        { name: "法界藏尊者", img: 14 }, { name: "天眼明尊者", img: 10 }, { name: "天耳通尊者", img: 11 }, 
        { name: "他心知尊者", img: 11 }, { name: "宿命通尊者", img: 11 }, { name: "神足通尊者", img: 11 }, 
        { name: "漏尽通尊者", img: 12 }, { name: "圆满觉尊者", img: 12 }
    ];    
    const POEMS = [
        { p: "春入眉心一点红，\n万事从今化大通。", h: "元旦伊始，百忧皆散，所求之事必有圆满回响。" },
        { p: "幽室千年暗未开，\n慧灯一焰破苍苔。", h: "旧岁之惑，当下即破。心有明灯，前路自现。" }
    ];

    let offsetX = 0, velocity = 0, isLocked = false, mode = 'TOUCH';
    const spacing = 320;
    const lotus = document.getElementById('lotus-cursor');
    const bgm = document.getElementById('bgm');

    // Hands Setup
    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
    
    hands.onResults(results => {
        // 如果结果页已显示，强制隐藏莲花并退出
        if (!document.getElementById('result-page').classList.contains('hidden')) {
            lotus.style.display = 'none';
            return;
        }
        if (isLocked || mode !== 'AR') return;

        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            lotus.style.display = 'none'; return;
        }

        const hand = results.multiHandLandmarks[0];
        const indexTip = hand[8];
        const thumbTip = hand[4];
        const x = (1 - indexTip.x) * window.innerWidth;
        const y = indexTip.y * window.innerHeight;

        const wrist = hand[0];
        const diff = wrist.x - 0.5; 

        if (Math.abs(diff) > 0.25) { 
            const direction = diff > 0 ? 1 : -1;
            velocity += direction * Math.pow(Math.abs(diff) - 0.25, 2) * 200;
            lotus.style.display = 'none'; 
        } else {
            lotus.style.display = 'block';
            lotus.style.left = `${x - 40}px`; 
            lotus.style.top = `${y - 40}px`;
            const target = checkAim(x);
            const dist = Math.sqrt(Math.pow(thumbTip.x - indexTip.x, 2) + Math.pow(thumbTip.y - indexTip.y, 2));
            if (dist < 0.08 && target) triggerPick(target);
        }
    });

    hands.initialize().then(() => { 
        document.getElementById('ar-btn').disabled = false;
        document.getElementById('loading-txt').innerText = "法眼已现，恭迎尊驾";
    });

    // Touch/Mouse Logic
    let isDragging = false, lastX = 0, startX = 0;
    document.addEventListener('pointerdown', e => {
        if (isLocked || mode !== 'TOUCH') return;
        isDragging = true; startX = e.clientX; lastX = e.clientX;
    });
    document.addEventListener('pointermove', e => {
        if (isLocked || mode !== 'TOUCH') return;
        if (isDragging) {
            offsetX += (e.clientX - lastX);
            lastX = e.clientX;
        } else {
            const w = window.innerWidth;
            if (e.clientX < w * 0.4) velocity -= Math.pow((w*0.4-e.clientX)/(w*0.4),2)*45;
            else if (e.clientX > w * 0.6) velocity += Math.pow((e.clientX-w*0.6)/(w*0.4),2)*45;
            checkAim(e.clientX);
        }
    });
    document.addEventListener('pointerup', e => {
        if (isLocked || mode !== 'TOUCH') return;
        isDragging = false;
        if (Math.abs(e.clientX - startX) < 15) {
            const t = checkAim(e.clientX);
            if (t) triggerPick(t);
        } else velocity = (e.clientX - startX) * 0.25;
    });

    function checkAim(cursorX) {
        const cards = document.querySelectorAll('.card');
        const centerX = window.innerWidth / 2;
        let aimed = null;
        cards.forEach((card, i) => {
            const cardX = centerX + offsetX + (i * spacing);
            if (!aimed && Math.abs(cursorX - cardX) < 110) {
                card.classList.add('target-aim');
                aimed = card;
            } else card.classList.remove('target-aim');
        });
        return aimed;
    }

    function triggerPick(card) {
        isLocked = true; velocity = 0;
        lotus.style.display = 'none';
        document.body.classList.remove('ar-active');
        card.classList.remove('target-aim');
        card.classList.add('card-picked');
        const index = Array.from(card.parentNode.children).indexOf(card);
        setTimeout(() => showResult(LOHANS[index]), 1400);
    }

    function initExperience(m) {
        mode = m;
        bgm.play().catch(()=>{});
        document.getElementById('home-page').classList.add('hidden');
        document.getElementById('draw-page').classList.remove('hidden');
        if (mode === 'AR') {
            document.body.classList.add('ar-active');
            document.getElementById('video-container').style.display = 'block';
            const v = document.getElementById('video-element');
            new Camera(v, { onFrame: async () => await hands.send({image: v}), width: 640, height: 480 }).start();
        }
        createCards();
        loop();
    }

    function createCards() {
        const c = document.getElementById('carousel');
        c.innerHTML = '';
        LOHANS.forEach((lohan, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.setProperty('--tx', `${i * spacing}px`);
            card.style.transform = `translateX(${i * spacing}px)`;
            c.appendChild(card);
        });
    }

    function loop() {
        if (!isDragging && !isLocked) {
            offsetX += velocity;
            velocity *= 0.93;
        }
        const minX = -(LOHANS.length - 1) * spacing;
        if (offsetX > 350) offsetX = 350;
        if (offsetX < minX - 350) offsetX = minX - 350;
        document.getElementById('carousel').style.transform = `translateX(${offsetX}px)`;
        requestAnimationFrame(loop);
    }

    function showResult(lohan) {
        document.getElementById('res-name').innerText = lohan.name;
        const rand = POEMS[Math.floor(Math.random() * POEMS.length)];
        document.getElementById('res-poem').innerText = rand.p;
        document.getElementById('res-interp').innerText = rand.h;
        document.getElementById('res-spirit-img').src = `${lohan.img}.jpg`;
        document.getElementById('draw-page').classList.add('hidden');
        document.getElementById('result-page').classList.remove('hidden');
        setTimeout(() => document.getElementById('spirit-box').classList.add('spirit-active'), 200);
        setTimeout(() => document.getElementById('scroll-obj').classList.add('scroll-active'), 1300);
    }
</script>
</body>
</html>